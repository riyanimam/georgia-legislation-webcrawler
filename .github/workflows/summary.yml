name: AI Issue Summary

on:
  issues:
    types: [opened]

jobs:
  summarize:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      models: read
      contents: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Extract issue content
      id: extract
      env:
        ISSUE_TITLE: ${{ github.event.issue.title }}
        ISSUE_BODY: ${{ github.event.issue.body }}
        ISSUE_LABELS: ${{ join(github.event.issue.labels.*.name, ', ') }}
      run: |
        # Extract and prepare issue content for summarization
        # Use environment variables to prevent code injection
        echo "title<<EOF" >> $GITHUB_OUTPUT
        echo "$ISSUE_TITLE" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

        echo "body<<EOF" >> $GITHUB_OUTPUT
        echo "$ISSUE_BODY" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

        echo "labels=$ISSUE_LABELS" >> $GITHUB_OUTPUT

    - name: Run AI inference for issue summary
      id: inference
      uses: actions/ai-inference@v1
      with:
        prompt: |
          Analyze the following GitHub issue from the georgia-legislation-webcrawler
          project and provide a concise summary.

          Title: ${{ steps.extract.outputs.title }}
          Labels: ${{ steps.extract.outputs.labels }}

          Body:
          ${{ steps.extract.outputs.body }}

          Please provide:
          1. A one-paragraph summary of the issue
          2. Key components affected (frontend/backend/infrastructure)
          3. Suggested next steps (if applicable)

          Format your response in Markdown.

    - name: Comment with AI summary
      if: steps.inference.outcome == 'success'
      run: |
        gh issue comment ${{ github.event.issue.number }} \
          --body "## üìã AI-Generated Summary

        ${{ steps.inference.outputs.response }}

        ---
        *This summary was automatically generated by AI.*"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Handle inference failure
      if: failure() && steps.inference.outcome == 'failure'
      run: |
        gh issue comment ${{ github.event.issue.number }} \
          --body "‚ö†Ô∏è Unable to generate AI summary at this time. Please review the issue manually."
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Add tracking labels
      run: |
        LABELS="${{ steps.extract.outputs.labels }}"
        if [[ -z "$LABELS" ]]; then
          gh issue edit ${{ github.event.issue.number }} --add-label "needs-triage"
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
