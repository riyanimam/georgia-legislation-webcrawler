name: Validation

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  validate-code:
    name: Validate Code Quality
    runs-on: ubuntu-latest
    steps:
      # Step 1: Clone the repository
    - name: Checkout repository
      uses: actions/checkout@v6

      # Step 2: Set up Python
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.11'

      # Step 3: Set up Node.js for markdownlint and tests
    - name: Set up Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'

      # Step 4: Install Python validation tools
    - name: Install Python validation tools
      run: |
        pip install ruff mdformat mdformat-gfm mdformat-tables yamllint

      # Step 5: Install Node.js validation tools and dependencies
    - name: Install Node.js dependencies
      run: |
        npm install
        npm install -g markdownlint-cli @biomejs/biome

      # Step 6: Run Biome check
    - name: Biome check
      run: biome ci --no-errors-on-unmatched

    - name: Ruff lint
      run: ruff check backend/scraper.py --fix --exit-zero

    - name: Ruff format check
      run: ruff format backend/scraper.py --line-length=100 --check

      # Step 9: Check Markdown formatting
    - name: Markdown format check
      run: mdformat README.md --wrap=100 --number --check

      # Step 10: Run Markdown linting
    - name: Markdownlint check
      run: markdownlint README.md --disable=MD013 --disable=MD024

      # Step 11: Validate YAML formatting
    - name: Yamllint check
      run: |
        yamllint .github/workflows/ --format=parsable --strict
        yamllint .pre-commit-config.yaml --format=parsable --strict

      # Step 12: Run unit tests
    - name: Run unit tests
      run: npm test

      # Step 13: Validate JSON schema
    - name: Validate JSON schema
      if: ${{ hashFiles('ga_legislation.json') != '' }}
      run: node scripts/validate-schema.js ga_legislation.json

      # Step 14: Validate accessibility
    - name: Validate accessibility
      run: node scripts/validate-accessibility.js frontend/index.html

  validate-pr-title:
    name: Validate PR Title Format
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
    - name: Validate PR Title Format
      uses: amannn/action-semantic-pull-request@v6
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        types: |
          feat
          fix
          docs
          style
          refactor
          perf
          test
          chore
          ci
        requireScope: false
        subjectPattern: ^\s*(?:[A-Za-z]|-).+$
        subjectPatternError: |
          The subject "{subject}" found in the pull request title "{title}" does not match the configured pattern.

          Please ensure the PR title follows the semantic commit format:
          - Type must be one of: feat, fix, docs, style, refactor, perf, test, chore, ci
          - Optional scope in parentheses: feat(scope):
          - Subject can start with uppercase or lowercase letter, or hyphen

          Example: "feat: Add new feature" or "fix(scraper): handle edge case"
